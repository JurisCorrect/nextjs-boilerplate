'use client'
import { useEffect, useState } from 'react'
import { useRouter } from 'next/navigation'

export default function DevTestCorrectionPage() {
  const router = useRouter()
  const [msg, setMsg] = useState('Préparation…')

  useEffect(() => {
    (async () => {
      try {
        setMsg('Création d’une soumission de démo…')
        const r = await fetch('/api/submissions/create', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            payload: { text:
              "Sujet : La responsabilité administrative pour faute.\n" +
              "Introduction — Depuis l'arrêt Blanco, la responsabilité de l'administration…\n" +
              "I. La faute simple demeure le principe…\nII. Vers un régime plus objectif…\nConclusion."
            }
          }),
        })
        const data = await r.json()
        if (!r.ok || !data?.submissionId) throw new Error(data?.error || 'create_failed')
        setMsg('Redirection vers la page correction…')
        router.replace(`/correction/${encodeURIComponent(data.submissionId)}`)
      } catch (e:any) {
        setMsg('Erreur : ' + (e?.message || 'inconnue'))
      }
    })()
  }, [router])

  return (
    <main style={{ minHeight:'60vh', display:'grid', placeItems:'center' }}>
      <div style={{ display:'grid', gap:12, textAlign:'center' }}>
        <div aria-label="Chargement" style={{
          width: 32, height: 32, borderRadius: '50%',
          border: '3px solid rgba(123,30,58,.25)', borderTopColor: '#7b1e3a',
          margin: '0 auto', animation: 'spin 1s linear infinite'
        }} />
        <p>{msg}</p>
      </div>
      <style>{`@keyframes spin{from{transform:rotate(0)}to{transform:rotate(360deg)}}`}</style>
    </main>
  )
}
